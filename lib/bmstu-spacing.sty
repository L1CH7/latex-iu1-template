%% lib/bmstu/bmstu-spacing.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bmstu-spacing}[2026/02/09 v1.1.0 Tight Spacing]

\RequirePackage{etoolbox}

% =========================================================
% 1. КОНСТАНТЫ И ПАРАМЕТРЫ
% =========================================================
% Базовый интервал (1.0 = 14pt)
\newlength{\spc@base}
\setlength{\spc@base}{14pt}

% Целевой интервал "пустой строки" (3.0 = 42pt)
\newlength{\spc@target}
\setlength{\spc@target}{42pt}

% Множители межстрочного интервала ПОДПИСЕЙ (1.0)
\newcommand{\spc@stretch@fig}{1.0}
\newcommand{\spc@stretch@tab}{1.0}
\newcommand{\spc@stretch@lst}{1.0}

% Отступ от основного текста до флоата (внешний)
\newlength{\spc@outer}
\setlength{\spc@outer}{14pt}

% =========================================================
% 2. ПЛАВАЮЩИЕ ОБЪЕКТЫ (Внешние отступы)
% =========================================================
\setlength{\intextsep}{\spc@outer} 
\setlength{\textfloatsep}{\spc@outer}
\setlength{\floatsep}{\spc@outer}

% =========================================================
% 3. ПОДПИСИ (CAPTION)
% =========================================================
\RequirePackage{caption}

% ВАЖНО: Отключаем автоматический skip пакета caption ПОЛНОСТЬЮ.
% Мы будем управлять им вручную через выше/ниже подписи.
\captionsetup{
    skip=0pt,
    labelsep=emdash, 
    singlelinecheck=false
}

% --- ТАБЛИЦЫ (Подпись СВЕРХУ) ---
\captionsetup[table]{
    position=top, 
    justification=raggedright,
    font={stretch=\spc@stretch@tab}
}

\AtBeginEnvironment{table}{% ИДЕАЛ НЕ ТРОГАТЬ
    \setlength{\parskip}{0pt}%
    % Для подписи СВЕРХУ: 
    % \belowcaptionskip - это отступ НАД подписью (в контексте caption package)
    % \abovecaptionskip - это отступ ПОД подписью (между ней и таблицей)
    \setlength{\belowcaptionskip}{12pt}% = 28pt + 14pt (внешний) = 42pt
    % \setlength{\belowcaptionskip}{\dimexpr \spc@target - \spc@outer \relax}% = 28pt + 14pt (внешний) = 42pt
    \setlength{\abovecaptionskip}{4pt}% Зазор до таблицы (ровно 2-4пт, чтобы не слиплось)
}

% --- РИСУНКИ (Подпись СНИЗУ) ---
\captionsetup[figure]{
    position=bottom, 
    justification=centering,
    font={stretch=\spc@stretch@fig}
}

\AtBeginEnvironment{figure}{% ИДЕАЛ НЕ ТРОГАТЬ
    \setlength{\parskip}{0pt}%
    % Для подписи СНИЗУ: 42-14=28 было а есть 75 
    % \abovecaptionskip - это отступ НАД подписью (между рисунком и ней)
    % \belowcaptionskip - это отступ ПОД подписью (до текста)
    \setlength{\abovecaptionskip}{6pt}% Зазор от картинки до подписи
    \setlength{\belowcaptionskip}{0pt}% = 28pt + 14pt (внешний) = 42pt
    % \setlength{\belowcaptionskip}{\dimexpr \spc@target - \spc@outer \relax}% = 28pt + 14pt (внешний) = 42pt
}

% =========================================================
% 4. ЛИСТИНГИ (LISTINGS)
% =========================================================
\RequirePackage{listings}

\captionsetup[lstlisting]{
    position=top, 
    justification=raggedright,
    font={stretch=\spc@stretch@lst}
}

\lstset{% ИДЕАЛ НЕ ТРОГАТЬ
    % Убираем внешние отступы самого блока кода (они неуправляемы и суммируются)
    aboveskip=0pt,
    belowskip=14pt, % Оставляем стандартный интервал после
    % Используем специальные параметры listings для отступов ПОДПИСИ
    % Т.к. листинги обычно не float, \intextsep не мешает, ставим ровно 42pt
    abovecaptionskip=21pt, 
    % abovecaptionskip=\spc@target, 
    belowcaptionskip=6pt,
    frame=single,
    framesep=5pt
}