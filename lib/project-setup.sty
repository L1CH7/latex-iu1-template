% lib/project-setup.sty
\ProvidesPackage{project-setup}

% --- Пакеты ---
\usepackage{graphicx}
\usepackage{shellesc} % Для запуска внешних команд
\usepackage{float}    % Чтобы работало [H] для картинок

% --- Пути поиска ресурсов ---
% Графика (картинки, диаграммы, логотипы)
\graphicspath{{assets/images/}{assets/diagrams/}{lib/bmstu/}}

% --- Настройка Mermaid (Локальный mmdc) ---
% Путь к mmdc внутри .nodeenv (относительно корня проекта)
\newcommand{\includemermaid}[2][width=\linewidth]{%
  \ShellEscape{%
    bash -c '
    MMDC=$(find . -name mmdc -path "*/.nodeenv/*" -type f -executable | head -n 1); %
    if [ -z "$MMDC" ]; then MMDC="./latex-iu1-template/.nodeenv/bin/mmdc"; fi; %
    %
    SRC="assets/diagrams/#2.mmd"; %
    PDF="assets/diagrams/#2.pdf"; %
    %
    if [ ! -f "$SRC" ]; then %
        echo "!!! [MERMAID ERROR] Source not found: $SRC !!!"; %
    elif [ ! -f "$PDF" ] || [ "$SRC" -nt "$PDF" ]; then %
        echo "--- [MERMAID] Rebuilding $PDF (Source is newer) ---"; %
        rm -f "$PDF"; %
        % Команда сборки БЕЗ обратных слэшей
        if "$MMDC" -i "$SRC" -o "$PDF" --pdfFit -b white -p assets/puppeteer-config.json -C assets/mermaid.css -c assets/mermaid-config.json; then %
            echo "--- [MERMAID] Success: $PDF updated ---"; %
            touch "$PDF"; %
        else %
            echo "!!! [MERMAID ERROR] Build failed for #2 !!!"; %
        fi; %
    fi' %
  }%
  \includegraphics[#1]{assets/diagrams/#2}%
}